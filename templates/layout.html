<!DOCTYPE html>
<html lang="{{ current_lang }}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="og:type" content="website">
    <meta property="og:site_name" content="{{ _('page_title') }}">
    <meta property="og:title" content="{{ _('og_title') }}">
    <meta property="og:description" content="{{ _('og_description') }}">
    <meta property="og:image" content="https://hi.johnlarckin.com/static/img/preview.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="{{ request.url_root }}{{ current_lang }}/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ _('twitter_title') }}">
    <meta name="twitter:description" content="{{ _('twitter_description') }}">
    <meta name="twitter:image" content="https://hi.johnlarckin.com/static/img/preview.png">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/grid.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/card.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/container.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hero.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/side.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/faq.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ui.css') }}">

    <title>{{ _('page_title') }}</title>

    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(100975624, "init", {
             clickmap:true,
             trackLinks:true,
             accurateTrackBounce:true,
             webvisor:true,
             defer: true
        });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/100975624" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

    <style>
        html.lenis { height: auto; }
        .lenis.lenis-smooth { scroll-behavior: auto !important; }
        .lenis.lenis-stopping iframe { pointer-events: none; }

        /* --- Стили для ПОСЛЕДОВАТЕЛЬНОЙ анимации КАЖДОГО элемента --- */
        .animate-sequential-item {
            opacity: 0; /* Начинаем невидимым */
            transform: translateY(30px); /* Начинаем ниже */
            transition: opacity 0.8s ease-out, transform 0.8s ease-out; /* Плавный переход */
            will-change: opacity, transform;
        }
        .animate-sequential-item.is-visible {
            opacity: 1; /* Становится видимым */
            transform: translateY(0); /* Возвращается на место */
        }
        /* --- Конец стилей анимации --- */

        /* Стиль для активной ссылки в меню */
        header.web nav a.link.active {
            opacity: 1 !important;
            color: var(--green) !important;
        }
        header.web nav a.link.active .nav-link-bar {
            height: 1em;
        }
        /* Стили палочки */
        header.web nav a.link { display: flex; align-items: center; position: relative; transition: opacity 0.3s ease, color 0.3s ease; }
        .nav-link-bar { display: inline-block; width: 2px; height: 0; background-color: var(--green); margin-right: 8px; transition: height 0.4s ease-out; will-change: height; }
        header.web nav a.link:hover .nav-link-bar { height: 1em; }
        header.web nav a.link:hover { opacity: 1; color: var(--green); }
        header.web nav a.link.opc:not(.opc--50) { opacity: 1; }
        .nav-link-text { display: inline-block; }

        /* Стили для переключателя языков */
        .language-switcher { position: fixed; top: 20px; right: 20px; z-index: 1000; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); padding: 5px; border-radius: 5px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .language-switcher a { text-decoration: none; padding: 5px 8px; color: #ccc; font-weight: bold; text-transform: uppercase; font-size: var(--xs); transition: color 0.2s ease; }
        .language-switcher a:hover { color: #fff; }
        .language-switcher a.active { color: #FFFFFF; pointer-events: none; cursor: default; }
    </style>

</head>

<body>

    <div class="language-switcher">
        {% for lang in supported_langs %}
            {% set view_args = request.view_args.copy() %}
            {% set _ = view_args.update({'lang_code': lang}) %}
            <a href="{{ url_for(request.endpoint, **view_args) }}"
               class="{{ 'active' if lang == current_lang else '' }}">
                {{ lang }}
            </a>
        {% endfor %}
    </div>


    <section class="base">

        <section class="aside--base">
             <!-- Хедер НЕ ДОЛЖЕН БЫТЬ sequential-container, если он виден сразу -->
            {% include 'header.html' %}
        </section>

        <section class="bside--base gp gp--xs">
            {% block main %}
            {% endblock %}

             <!-- ЭТОТ блок - контейнер-триггер для FAQ -->
            <section class="faq pd pd__hg gp gp--xxl sequential-container" id="faq">
                {% include 'faq.html' %}
            </section>

             <!-- ЭТОТ блок - контейнер-триггер для Footer -->
            <footer class="gp gp--xxl sequential-container">
                {% include 'footer.html' %}
            </footer>

        </section>

    </section>

    <script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>

    <script>
        let lenis;
        if (typeof Lenis !== 'undefined') {
             // --- ИЗМЕНЕНИЕ ЗДЕСЬ: Добавляем опции для тач-устройств ---
             lenis = new Lenis({
                 smoothTouch: true, // <--- Добавлено
                 touchMultiplier: 1.5 // <--- Добавлено (можно настроить или убрать)
             });
             // -------------------------------------------------------
             function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
             requestAnimationFrame(raf);
        } else {
             console.error("Lenis library not loaded.");
        }

        // --- Последовательная анимация элементов ВНУТРИ контейнера ---
        function initSequentialAnimation() {
            const containers = document.querySelectorAll('.sequential-container'); // Ищем триггеры
            const itemStaggerDelay = 80; // мс задержка между элементами

            if (!containers.length) return;

            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1 // Запускаем когда 10% контейнера видно
            };

            const observerCallback = (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const containerElement = entry.target;
                        // Ищем элементы для анимации ВНУТРИ сработавшего триггера
                        const itemsToAnimate = containerElement.querySelectorAll('.animate-sequential-item');

                        if (itemsToAnimate.length > 0) {
                            itemsToAnimate.forEach((item, index) => {
                                const delay = index * itemStaggerDelay;
                                setTimeout(() => {
                                    item.classList.add('is-visible');
                                }, delay);
                            });
                        }
                        observer.unobserve(containerElement); // Отписываемся после первого срабатывания
                    }
                });
            };

            const observer = new IntersectionObserver(observerCallback, observerOptions);
            containers.forEach(container => observer.observe(container));
        }

        // --- Навигация ---
        function initNavigation() {
             // 1. Smooth Scroll
             document.querySelectorAll('header.web a[href^="#"]').forEach(anchor => {
                 anchor.addEventListener('click', function (e) {
                     e.preventDefault();
                     const targetId = this.getAttribute('href');
                     if (targetId && targetId.length > 1) {
                         const targetElement = document.querySelector(targetId);
                         if (targetElement && typeof lenis !== 'undefined') {
                             lenis.scrollTo(targetElement, { duration: 1.2 });
                         } else if (targetElement) {
                             targetElement.scrollIntoView({ behavior: 'smooth' });
                         } else {
                             console.warn("Target element not found for anchor:", targetId);
                         }
                     }
                 });
             });

            // 2. Active Nav Link Highlighting
            const navLinks = document.querySelectorAll('header.web nav a.link[href^="#"]');
            // Ищем секции во всем документе, а не только в main/footer
            const sections = document.querySelectorAll('section[id]');
            const sectionMap = new Map();

             if (!navLinks.length || !sections.length) return;

             sections.forEach(section => {
                 // Убедимся, что ID секции не пустой
                 if (section.id) {
                    const correspondingLink = document.querySelector(`header.web a.link[href="#${section.id}"]`);
                    if (correspondingLink) {
                        sectionMap.set(section, correspondingLink);
                    }
                 }
             });
             // Проверяем, что хоть что-то добавилось в Map
             if (sectionMap.size === 0) {
                console.warn("No sections with corresponding nav links found for highlighting.");
                return;
             }

            const observerOptions = {
                root: null,
                rootMargin: '-40% 0px -60% 0px',
                threshold: 0
            };

             const activateLink = (linkToActivate) => {
                 navLinks.forEach(link => link.classList.remove('active'));
                 if (linkToActivate) {
                     linkToActivate.classList.add('active');
                 }
             };

            const observerCallback = (entries) => {
                let activeSectionFound = false;
                 entries.reverse().forEach(entry => {
                     if (!activeSectionFound && entry.isIntersecting) {
                         const link = sectionMap.get(entry.target);
                         if (link) {
                             activateLink(link);
                             activeSectionFound = true;
                         }
                     }
                 });
                 if (!activeSectionFound) {
                    // Если ни одна секция не активна в данный момент,
                    // попробуем найти последнюю секцию, которая была пересечена сверху
                    // (Это более сложная логика, пока оставим просто сброс)
                    activateLink(null);
                 }
            };

            const scrollObserver = new IntersectionObserver(observerCallback, observerOptions);
            sectionMap.forEach((link, section) => scrollObserver.observe(section));
        }

        // --- Запуск скриптов ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof Lenis !== 'undefined') {
                 initNavigation();
            } else {
                 console.warn("Initializing navigation without Lenis for anchors.");
                 initNavigation();
            }
            initSequentialAnimation(); // Запускаем последовательную анимацию
        });
    </script>
</body>
</html>